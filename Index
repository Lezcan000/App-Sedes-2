<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Sedes - Alcald√≠a</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            /* COLORES DE TU IMAGEN ORIGINAL */
            --header-bg: #2180a1; 
            --header-bg-gradient: linear-gradient(90deg, #2180a1 0%, #32b8c6 100%);
            --light-bg: #f4f6f9;
            --text-dark: #2c3e50;
            --border: #e1e4e8;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--light-bg);
            color: var(--text-dark);
            padding: 20px;
        }
        .container { max-width: 1350px; margin: 0 auto; }

        /* HEADER SIMPLE (LOGO + TITULO) */
        header { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .logo-img { height: 60px; width: auto; }
        header h1 { color: var(--header-bg); font-size: 2em; font-weight: 700; margin: 0; }

        /* ESTADISTICAS SIMPLES */
        .stats { display: flex; gap: 15px; margin-bottom: 20px; justify-content: space-between; }
        .stat-card { background: white; flex: 1; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; border-bottom: 3px solid var(--header-bg); }
        .stat-card h3 { font-size: 0.8em; color: #777; margin-bottom: 5px; font-weight: 600; text-transform: uppercase; }
        .stat-card .number { font-size: 1.5em; font-weight: 700; color: var(--text-dark); }

        /* CONTROLES */
        .controls { display: flex; gap: 10px; margin-bottom: 15px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); align-items: center; }
        .search-box { flex: 1; }
        .search-box input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 1em; }
        
        .btn { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: 600; font-size: 0.9em; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--header-bg); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-secondary { background: #6c757d; }
        .btn-folder { background: #e67e22; }

        /* TABLA ESTILO ORIGINAL */
        .table-container { background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        
        /* CABECERA AZUL/PETR√ìLEO COMO EN TU FOTO */
        thead { background: var(--header-bg-gradient); color: white; }
        th { padding: 15px; text-align: left; font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        
        td { padding: 12px 15px; border-bottom: 1px solid var(--border); font-size: 0.9em; vertical-align: top; }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover { background-color: #f8f9fa; }

        /* COLUMNA GESTIONES */
        .gestion-cell { display: flex; flex-direction: column; gap: 3px; }
        .tag { font-size: 0.75em; padding: 2px 6px; border-radius: 3px; background: #eee; color: #555; width: fit-content; display: inline-block; }
        .tag.count { background: #e3f2fd; color: #007bff; font-weight: bold; }

        .actions { display: flex; gap: 5px; }
        .btn-sm { padding: 5px 8px; font-size: 0.8em; }

        /* MODALES */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; padding: 25px; position: relative; }
        .modal-content.wide { max-width: 850px; }
        .close-btn { position: absolute; top: 15px; right: 20px; border: none; background: none; font-size: 1.5em; cursor: pointer; color: #999; }
        
        h2.modal-title { margin-top: 0; color: var(--header-bg); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 20px; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 15px; }
        .form-group.full { grid-column: 1 / -1; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9em; color: #555; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

        /* LISTA GESTIONES DENTRO DEL MODAL */
        .historial-list { border: 1px solid #eee; border-radius: 4px; max-height: 300px; overflow-y: auto; }
        .historial-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
        .historial-item:last-child { border-bottom: none; }
        .historial-item:hover { background: #f9f9f9; }

        /* UTILIDADES */
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #ddd; border-top: 4px solid var(--header-bg); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .toast { position: fixed; top: 20px; right: 20px; padding: 15px; background: white; border-left: 4px solid var(--success); box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: none; z-index: 3000; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <img src="logo.png" alt="Logo" class="logo-img" onerror="this.style.display='none'">
            <h1>Gestor de Sedes</h1>
        </header>

        <div class="stats">
            <div class="stat-card"><h3>Total Sedes</h3><div class="number" id="statTotal">0</div></div>
            <div class="stat-card"><h3>Sedes Sociales</h3><div class="number" id="statSocial">0</div></div>
            <div class="stat-card"><h3>CDS</h3><div class="number" id="statCDS">0</div></div>
            <div class="stat-card"><h3>Gestiones</h3><div class="number" id="statGestiones">0</div></div>
        </div>

        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Buscar por nombre, direcci√≥n o comuna...">
            </div>
            <button class="btn btn-primary" onclick="openSedeModal()">‚ûï Nueva Sede</button>
            <button class="btn btn-primary" onclick="loadData()">üîÑ Recargar</button>
            <button class="btn btn-success" onclick="exportExcel()">üì• Excel</button>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 50px;">No.</th>
                        <th>Bien Inmueble</th>
                        <th>Comuna</th>
                        <th>Direcci√≥n / Uso</th>
                        <th>Ocupante</th>
                        <th style="width: 200px;">Gestiones</th>
                        <th style="width: 140px;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="loader" class="loader-overlay"><div class="spinner"></div><p>Procesando...</p></div>
    <div id="toast" class="toast">Notificaci√≥n</div>

    <div id="modalSede" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('modalSede')">√ó</button>
            <h2 class="modal-title" id="modalSedeTitle">Nueva Sede</h2>
            <form id="formSede" onsubmit="event.preventDefault(); saveSede();">
                <input type="hidden" id="originalNumero">
                <div class="form-grid">
                    <div class="form-group"><label>N√∫mero</label><input type="number" id="numero" required></div>
                    <div class="form-group"><label>Nombre</label><input type="text" id="nombre" required></div>
                    <div class="form-group"><label>Comuna</label><input type="text" id="comuna" required></div>
                    <div class="form-group"><label>Uso</label><input type="text" id="uso" required></div>
                    <div class="form-group full"><label>Direcci√≥n</label><input type="text" id="direccion" required></div>
                    <div class="form-group full"><label>Ocupante</label><input type="text" id="ocupante"></div>
                    <div class="form-group full"><label>Observaciones</label><textarea id="observaciones"></textarea></div>
                </div>
                <div style="text-align: right; margin-top: 15px;">
                    <button type="submit" class="btn btn-primary">Guardar Datos</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalGestiones" class="modal">
        <div class="modal-content wide">
            <button class="close-btn" onclick="closeModal('modalGestiones')">√ó</button>
            <h2 class="modal-title" id="gestionTitle">Gestiones</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div style="background: #fdfdfd; padding: 15px; border: 1px solid #eee; border-radius: 6px;">
                    <h4 style="margin-top: 0; color: #e67e22;">üìù Registrar Nueva</h4>
                    <form id="formGestion">
                        <div class="form-group">
                            <label>Tipo</label>
                            <select id="gTipo">
                                <option>Supervisi√≥n T√©cnica</option>
                                <option>Mantenimiento</option>
                                <option>Comodato Muebles</option>
                                <option>Comodato Inmuebles</option>
                                <option>Servicios P√∫blicos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fecha</label>
                            <input type="date" id="gFecha">
                        </div>
                        <div class="form-group">
                            <label>Evidencia (PDF - Nombre)</label>
                            <input type="file" id="gArchivo">
                        </div>
                        <div class="form-group">
                            <label>Notas</label>
                            <textarea id="gNotas" rows="2"></textarea>
                        </div>
                        <button type="button" class="btn btn-folder" style="width:100%" onclick="saveGestion()">Guardar Gesti√≥n</button>
                    </form>
                </div>

                <div>
                    <h4 style="margin-top: 0; color: var(--text-dark);">üìÇ Historial</h4>
                    <div id="listHistory" class="historial-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACI√ìN ---
        // PEGA AQU√ç TU NUEVA URL DE APPS SCRIPT LUEGO DE ACTUALIZARLO
        const API_URL = "https://script.google.com/macros/s/AKfycbx9lcc1p12JO82WMHP5GbuDMy_V0poH8uBzH0cLPsCLUWEjb9G7EiiuzwDhfsHOXc9U/exec"; 

        let allData = []; // Guardar√° sedes con sus gestiones dentro
        let currentSedeId = null;
        let isEditing = false;

        async function loadData() {
            document.getElementById('loader').style.display = 'flex';
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                if(Array.isArray(data)) {
                    allData = data;
                    renderTable();
                    updateStats();
                    showToast("Datos actualizados");
                }
            } catch(e) {
                console.error(e);
                alert("Error cargando datos. Revisa la conexi√≥n.");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function renderTable() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const filtered = allData.filter(s => 
                (s.nombre + s.direccion + s.comuna + s.ocupante).toLowerCase().includes(term)
            );

            filtered.forEach((sede, idx) => {
                // Preparar resumen de gestiones
                let gestionHTML = '<span style="color:#aaa; font-size:0.8em">Sin registros</span>';
                if (sede.gestiones && sede.gestiones.length > 0) {
                    const count = sede.gestiones.length;
                    const last = sede.gestiones[sede.gestiones.length - 1];
                    // Formatear fecha si viene de Google
                    let fechaStr = last.fecha;
                    if(fechaStr && fechaStr.includes('T')) fechaStr = fechaStr.split('T')[0];

                    gestionHTML = `
                        <div class="gestion-cell">
                            <span class="tag count">${count} Registros</span>
                            <span class="tag" style="background:#fff3e0; border:1px solid #ffe0b2; color:#e65100">
                                √ölt: ${last.tipo} (${fechaStr})
                            </span>
                        </div>
                    `;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><b>${sede.numero}</b></td>
                    <td style="font-weight:bold; color:#2c3e50">${sede.nombre}</td>
                    <td>${sede.comuna}</td>
                    <td>
                        <div>${sede.direccion}</div>
                        <div style="font-size:0.85em; color:#777; margin-top:3px">${sede.uso}</div>
                    </td>
                    <td><small>${sede.ocupante || '-'}</small></td>
                    <td>${gestionHTML}</td>
                    <td>
                        <div class="actions">
                            <button class="btn btn-folder btn-sm" onclick="openGestiones(${sede.numero})" title="Ver Gestiones">üìÇ</button>
                            <button class="btn btn-secondary btn-sm" onclick="openEdit(${allData.indexOf(sede)})" title="Editar">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteSede(${sede.numero})" title="Borrar">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- GESTIONES ---
        function openGestiones(id) {
            currentSedeId = id;
            const sede = allData.find(s => s.numero == id);
            document.getElementById('gestionTitle').textContent = `Gestiones: ${sede.nombre}`;
            renderHistory(sede.gestiones || []);
            document.getElementById('modalGestiones').classList.add('active');
        }

        function renderHistory(list) {
            const container = document.getElementById('listHistory');
            if(list.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; padding:10px;">No hay documentos.</p>';
                return;
            }
            container.innerHTML = list.map(g => {
                let fecha = g.fecha;
                if(fecha && fecha.toString().includes('T')) fecha = fecha.toString().split('T')[0];
                return `
                <div class="historial-item">
                    <div>
                        <div style="font-weight:bold; color:#2180a1">${g.tipo}</div>
                        <div style="font-size:0.85em; color:#666">${fecha}</div>
                        <div style="font-size:0.85em; font-style:italic">${g.notas || ''}</div>
                    </div>
                    ${g.archivo ? 'üìé' : ''}
                </div>`;
            }).join('');
        }

        async function saveGestion() {
            const tipo = document.getElementById('gTipo').value;
            const fecha = document.getElementById('gFecha').value;
            const archivoInput = document.getElementById('gArchivo');
            const notas = document.getElementById('gNotas').value;

            if(!fecha) return alert("Fecha obligatoria");

            const pass = prompt("üîê Contrase√±a:");
            if(!pass) return;

            document.getElementById('loader').style.display = 'flex';

            const payload = {
                action: 'addGestion',
                password: pass,
                sedeNumero: currentSedeId,
                tipo: tipo,
                fecha: fecha,
                fileName: archivoInput.files.length > 0 ? archivoInput.files[0].name : "N/A",
                notas: notas
            };

            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                
                if(json.status === 'success') {
                    showToast("Gesti√≥n guardada");
                    document.getElementById('formGestion').reset();
                    document.getElementById('modalGestiones').classList.remove('active');
                    loadData(); // Recargar todo para ver la nueva gesti√≥n
                } else {
                    alert(json.message);
                }
            } catch(e) { console.error(e); alert("Error guardando"); }
            finally { document.getElementById('loader').style.display = 'none'; }
        }

        // --- SEDES CRUD ---
        function openSedeModal() {
            isEditing = false;
            document.getElementById('modalSedeTitle').textContent = "Nueva Sede";
            document.getElementById('formSede').reset();
            // Auto ID
            const max = allData.reduce((m, s) => Math.max(m, parseInt(s.numero)||0), 0);
            document.getElementById('numero').value = max + 1;
            document.getElementById('modalSede').classList.add('active');
        }

        function openEdit(idx) {
            isEditing = true;
            const s = allData[idx];
            document.getElementById('modalSedeTitle').textContent = "Editar Sede";
            document.getElementById('originalNumero').value = s.numero;
            document.getElementById('numero').value = s.numero;
            document.getElementById('nombre').value = s.nombre;
            document.getElementById('comuna').value = s.comuna;
            document.getElementById('direccion').value = s.direccion;
            document.getElementById('uso').value = s.uso;
            document.getElementById('ocupante').value = s.ocupante;
            document.getElementById('observaciones').value = s.observaciones;
            document.getElementById('modalSede').classList.add('active');
        }

        async function saveSede() {
            const pass = prompt("üîê Contrase√±a:");
            if(!pass) return;

            const payload = {
                action: isEditing ? 'edit' : 'add',
                password: pass,
                originalNumero: document.getElementById('originalNumero').value,
                numero: document.getElementById('numero').value,
                nombre: document.getElementById('nombre').value,
                comuna: document.getElementById('comuna').value,
                direccion: document.getElementById('direccion').value,
                uso: document.getElementById('uso').value,
                ocupante: document.getElementById('ocupante').value,
                observaciones: document.getElementById('observaciones').value
            };

            document.getElementById('loader').style.display = 'flex';
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
                const json = await res.json();
                if(json.status === 'success') {
                    showToast("Guardado con √©xito");
                    closeModal('modalSede');
                    loadData();
                } else {
                    alert(json.message);
                }
            } catch(e) { alert("Error de red"); }
            finally { document.getElementById('loader').style.display = 'none'; }
        }

        async function deleteSede(id) {
            if(!confirm("¬øEliminar esta sede?")) return;
            const pass = prompt("üîê Contrase√±a:");
            if(!pass) return;

            document.getElementById('loader').style.display = 'flex';
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({action:'delete', password:pass, numero:id}) });
                const json = await res.json();
                if(json.status === 'success') {
                    showToast("Eliminado");
                    loadData();
                } else {
                    alert(json.message);
                }
            } catch(e) { alert("Error"); }
            finally { document.getElementById('loader').style.display = 'none'; }
        }

        // --- EXTRAS ---
        function updateStats() {
            document.getElementById('statTotal').textContent = allData.length;
            document.getElementById('statSocial').textContent = allData.filter(s=> (s.uso||"").toUpperCase().includes("SOCIAL")).length;
            document.getElementById('statCDS').textContent = allData.filter(s=> (s.uso||"").toUpperCase().includes("CENTRO")).length;
            // Contar total gestiones
            let totalG = 0;
            allData.forEach(s => { if(s.gestiones) totalG += s.gestiones.length; });
            document.getElementById('statGestiones').textContent = totalG;
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function exportExcel() { alert("Generando Excel..."); } // Mantener tu funci√≥n existente si la deseas

        document.getElementById('searchInput').addEventListener('input', renderTable);
        
        // INICIAR
        loadData();
    </script>
</body>
</html>
